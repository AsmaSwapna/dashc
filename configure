#!/bin/sh

sudo apt -y install opam m4 git

opam init --auto-setup --comp 4.06.1 --yes
opam switch 4.06.1
eval `opam config env`
opam install -y jbuilder core async xml-light alcotest

echo "Clone cohttp and switch to the first commit of 2018.03.23, version 1.1.0"
git clone https://github.com/mirage/ocaml-cohttp.git
cd ocaml-cohttp/
git checkout b30207c779b56de78d925f271b895e4288b3abb7
cd ..

rm ocaml-cohttp/cohttp-async/src/client.ml
rm ocaml-cohttp/cohttp-async/src/client.mli
cp ocaml-cohttp_/cohttp-async/src/client.ml ocaml-cohttp/cohttp-async/src/client.ml

opam remove -y cohttp cohttp-async

opam pin add -y cohttp ocaml-cohttp
opam pin add -y cohttp-async ocaml-cohttp